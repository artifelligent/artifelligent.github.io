<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcard App (Text Only)</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4a90e2">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .list-item:nth-child(odd) { background-color: #f9fafb; }
        .list-item:nth-child(even) { background-color: #ffffff; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-4xl font-bold text-center mb-8">Flashcard App (Text Only)</h1>

        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
             <h2 class="text-xl font-semibold mb-4">Create New Flashcard</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <h3 class="font-medium">Front Side</h3>
                    <div>
                        <label for="frontText" class="block text-sm font-medium text-gray-700 mb-1">Text</label>
                        <textarea id="frontText" class="w-full border border-gray-300 rounded-md p-2 h-32" aria-label="Front side text"></textarea>
                    </div>
                </div>
                <div class="space-y-4">
                    <h3 class="font-medium">Back Side</h3>
                    <div>
                        <label for="backText" class="block text-sm font-medium text-gray-700 mb-1">Text</label>
                        <textarea id="backText" class="w-full border border-gray-300 rounded-md p-2 h-32" aria-label="Back side text"></textarea>
                    </div>
                </div>
            </div>
            <button id="createCardBtn" class="mt-6 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">Create Flashcard</button>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Manage Flashcards</h2>
            <div class="flex flex-col sm:flex-row gap-4 items-start">
                <button id="exportBtn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">Export All Flashcards</button>

                <div class="flex flex-col gap-2">
                     <div class="flex items-center gap-4">
                        <button id="importBtn" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition-colors">Import from File</button>
                        <input type="file" id="importFile" accept=".json" style="display: none;" aria-hidden="true">
                     </div>
                     <div class="text-sm text-gray-600">
                        <label class="inline-flex items-center mr-4">
                            <input type="radio" name="importMode" value="merge" class="form-radio" checked>
                            <span class="ml-2">Merge with existing</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="importMode" value="replace" class="form-radio">
                            <span class="ml-2">Replace existing</span>
                        </label>
                     </div>
                </div>
            </div>
            <p class="text-xs text-gray-500 mt-4">Export saves your cards to a JSON file. Import loads cards from a previously exported file.</p>
        </div>
        <div class="space-y-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Your Flashcards</h2>
                <div>
                    <button id="gridViewBtn" class="px-3 py-1 border border-blue-600 text-blue-600 bg-blue-100 rounded-l-md text-sm">Grid</button>
                    <button id="listViewBtn" class="px-3 py-1 border-t border-b border-r border-blue-600 text-blue-600 bg-white rounded-r-md text-sm">List</button>
                </div>
            </div>
            <div id="flashcardsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
            <div id="flashcardsListContainer" class="hidden bg-white rounded-lg shadow-md overflow-hidden">
                 </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM elements
            const frontTextInput = document.getElementById('frontText');
            const backTextInput = document.getElementById('backText');
            const createCardBtn = document.getElementById('createCardBtn');
            const flashcardsContainer = document.getElementById('flashcardsContainer');
            const flashcardsListContainer = document.getElementById('flashcardsListContainer');
            const gridViewBtn = document.getElementById('gridViewBtn');
            const listViewBtn = document.getElementById('listViewBtn');
            // Added Export/Import elements
            const exportBtn = document.getElementById('exportBtn');
            const importBtn = document.getElementById('importBtn');
            const importFile = document.getElementById('importFile');


            let currentView = 'grid';

            // Event Listeners
            createCardBtn.addEventListener('click', handleCreateFlashcard);
            gridViewBtn.addEventListener('click', () => switchView('grid'));
            listViewBtn.addEventListener('click', () => switchView('list'));
            // Added Export/Import listeners
            exportBtn.addEventListener('click', handleExport);
            importBtn.addEventListener('click', () => importFile.click()); // Trigger hidden file input
            importFile.addEventListener('change', handleFileSelect); // Listen for file selection


            // Initial Load
            loadAndRenderViews();
            switchView(localStorage.getItem('flashcardView') || 'grid');

            // --- Functions ---

            function handleCreateFlashcard() {
                const frontText = frontTextInput.value.trim();
                const backText = backTextInput.value.trim();
                if (!frontText || !backText) {
                    alert('Please add text to both sides of the flashcard.');
                    return;
                }
                const newFlashcard = { id: Date.now(), frontText, backText };
                saveFlashcard(newFlashcard);
                resetForm();
                loadAndRenderViews();
            }

            function saveFlashcard(flashcard) {
                const flashcards = getFlashcards();
                flashcards.push(flashcard);
                // Use try...catch for saving in case of quota errors, though less likely now
                try {
                    localStorage.setItem('flashcards', JSON.stringify(flashcards));
                } catch (error) {
                     console.error("Error saving flashcards to localStorage:", error);
                     alert(`Error saving card: ${error.message}\nStorage might be full.`);
                     // Optionally remove the card just added if save failed
                     // flashcards.pop(); // Remove the card that failed to save
                }
            }

             function resetForm() {
                frontTextInput.value = '';
                backTextInput.value = '';
            }

             function getFlashcards() {
                const storedCards = localStorage.getItem('flashcards');
                if (storedCards) { try { const parsedCards = JSON.parse(storedCards); return Array.isArray(parsedCards) ? parsedCards : []; } catch (e) { console.error("Error parsing flashcards from localStorage:", e); return []; } } return [];
            }

             function loadAndRenderViews() {
                const flashcards = getFlashcards();
                renderGridView(flashcards);
                renderListView(flashcards);
            }

             function renderGridView(flashcards) {
                flashcardsContainer.innerHTML = '';
                flashcards.forEach(flashcard => { if (flashcard?.id !== undefined) addFlashcardToGridDisplay(flashcard); });
            }

             function renderListView(flashcards) {
                flashcardsListContainer.innerHTML = '';
                if (flashcards.length === 0) { flashcardsListContainer.innerHTML = '<p class="text-center text-gray-500 p-4">No flashcards yet.</p>'; return; }
                const list = document.createElement('ul');
                flashcards.forEach(flashcard => {
                    if (flashcard?.id !== undefined) {
                        const listItem = document.createElement('li'); listItem.classList.add('list-item', 'p-3', 'flex', 'justify-between', 'items-center', 'border-b', 'last:border-b-0'); listItem.dataset.id = flashcard.id;
                        const textDiv = document.createElement('div'); textDiv.classList.add('text-sm', 'truncate', 'pr-2');
                        textDiv.textContent = flashcard.frontText || '[No Front Text]';
                        const deleteBtn = createDeleteButton(flashcard.id);
                        listItem.appendChild(textDiv); listItem.appendChild(deleteBtn); list.appendChild(listItem);
                    }
                });
                 flashcardsListContainer.appendChild(list);
            }

             function createDeleteButton(id) {
                const deleteBtn = document.createElement('button'); deleteBtn.innerHTML = '&times;'; deleteBtn.setAttribute('aria-label', 'Delete flashcard');
                deleteBtn.classList.add('bg-red-500', 'text-white', 'rounded-full', 'w-5', 'h-5', 'flex', 'items-center', 'justify-center', 'text-xs', 'flex-shrink-0', 'hover:bg-red-600', 'transition-colors');
                deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); if (confirm('Are you sure you want to delete this flashcard?')) deleteFlashcard(id); }); return deleteBtn;
            }

             function deleteFlashcard(id) {
                let flashcards = getFlashcards(); flashcards = flashcards.filter(card => card.id !== id); localStorage.setItem('flashcards', JSON.stringify(flashcards)); loadAndRenderViews();
            }

             function switchView(viewToShow) {
                currentView = viewToShow; localStorage.setItem('flashcardView', viewToShow);
                if (viewToShow === 'grid') {
                    flashcardsContainer.classList.remove('hidden'); flashcardsListContainer.classList.add('hidden');
                    gridViewBtn.classList.add('bg-blue-100'); gridViewBtn.classList.remove('bg-white'); listViewBtn.classList.add('bg-white'); listViewBtn.classList.remove('bg-blue-100');
                } else {
                    flashcardsContainer.classList.add('hidden'); flashcardsListContainer.classList.remove('hidden');
                    gridViewBtn.classList.add('bg-white'); gridViewBtn.classList.remove('bg-blue-100'); listViewBtn.classList.add('bg-blue-100'); listViewBtn.classList.remove('bg-white');
                }
            }

            function addFlashcardToGridDisplay(flashcard) {
                const cardElement = document.createElement('div');
                cardElement.classList.add('flashcard', 'relative', 'bg-white', 'rounded-lg', 'shadow-md', 'h-64', 'cursor-pointer', 'flex', 'flex-col', 'p-4', 'border', 'border-gray-200', 'overflow-hidden');
                cardElement.dataset.id = flashcard.id;
                cardElement.dataset.showing = 'front';

                const cardFace = document.createElement('div');
                cardFace.classList.add('card-face', 'flex-grow', 'overflow-auto', 'flex', 'flex-col', 'justify-center', 'items-center', 'text-center');

                function renderSide(sideToShow) {
                    cardFace.innerHTML = '';
                    const textToShow = (sideToShow === 'front') ? flashcard.frontText : flashcard.backText;
                    const textDiv = document.createElement('div');
                    textDiv.classList.add('text-4xl'); // Kept user's preferred size
                    textDiv.textContent = textToShow;
                    cardFace.appendChild(textDiv);
                    cardElement.dataset.showing = sideToShow;
                }

                renderSide('front');

                const switchSideText = document.createElement('div');
                switchSideText.classList.add('text-xs', 'text-gray-500', 'text-center', 'mt-auto', 'pt-2', 'flex-shrink-0');
                switchSideText.textContent = 'Click to show back';

                cardElement.appendChild(cardFace);
                cardElement.appendChild(switchSideText);

                const deleteBtn = createDeleteButton(flashcard.id);
                deleteBtn.classList.add('absolute', 'top-2', 'right-2', 'z-10', 'opacity-50', 'hover:opacity-100', 'transition-opacity');
                cardElement.appendChild(deleteBtn);

                flashcardsContainer.appendChild(cardElement);

                cardElement.addEventListener('click', (e) => {
                    if (e.target.closest('button')) { return; }
                    const currentState = cardElement.dataset.showing;
                    const newState = (currentState === 'front') ? 'back' : 'front';
                    renderSide(newState);
                    switchSideText.textContent = (newState === 'front') ? 'Click to show back' : 'Click to show front';
                });
            }


        // --- NEW Export Function ---
        function handleExport() {
            const flashcards = getFlashcards();
            if (flashcards.length === 0) {
                alert("There are no flashcards to export.");
                return;
            }
            const jsonString = JSON.stringify(flashcards, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            a.download = `flashcards_export_${timestamp}.json`;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
             alert(`Exported ${flashcards.length} flashcards.`);
        }

        // --- NEW Import Functions ---
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) { return; }

             if (!file.name.endsWith('.json')) {
                 alert("Please select a valid .json file exported from this app.");
                 event.target.value = null; return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const fileContent = e.target.result;
                let importedFlashcards;
                try {
                    importedFlashcards = JSON.parse(fileContent);
                    if (!Array.isArray(importedFlashcards)) { throw new Error("Invalid file format: Not a JSON array."); }
                    const isValidStructure = importedFlashcards.every(item => typeof item === 'object' && item !== null && item.hasOwnProperty('id') && item.hasOwnProperty('frontText') && item.hasOwnProperty('backText'));
                     if (!isValidStructure && importedFlashcards.length > 0) { throw new Error("Invalid file format: Data structure doesn't match expected flashcard format."); }
                } catch (error) {
                    console.error("Error reading or parsing JSON file:", error);
                    alert(`Error importing file: ${error.message}\nPlease ensure the file is a valid JSON exported from this app.`);
                     event.target.value = null; return;
                }

                const importMode = document.querySelector('input[name="importMode"]:checked')?.value || 'merge';
                let currentFlashcards = getFlashcards();
                let finalFlashcards;
                let importedCount = importedFlashcards.length;
                let addedCount = 0;

                if (importMode === 'replace') {
                    finalFlashcards = importedFlashcards;
                    addedCount = importedFlashcards.length;
                } else { // Merge
                    finalFlashcards = [...currentFlashcards];
                    const currentIds = new Set(currentFlashcards.map(card => card.id));
                    importedFlashcards.forEach(importedCard => {
                        // Add if ID doesn't exist OR if it's a very old card maybe without proper ID (basic safety)
                        if (!currentIds.has(importedCard.id) && importedCard.id) {
                            finalFlashcards.push(importedCard);
                            addedCount++;
                        }
                    });
                }

                 try { localStorage.setItem('flashcards', JSON.stringify(finalFlashcards)); }
                 catch (error) {
                    console.error("Error saving imported flashcards to localStorage:", error);
                    alert(`Error saving imported cards: ${error.message}\nStorage might be full.`);
                    event.target.value = null; return;
                 }

                loadAndRenderViews();
                alert(`Import successful!\nMode: ${importMode}\nCards in file: ${importedCount}\nNew cards added/merged: ${addedCount}\nTotal cards now: ${finalFlashcards.length}`);
                event.target.value = null; // Reset file input
            };
             reader.onerror = function(e) { console.error("Error reading file:", e); alert("An error occurred while trying to read the file."); event.target.value = null; };
            reader.readAsText(file);
        }


     });// End DOMContentLoaded
    </script>
    <script>
        // Register the Service Worker (Keep this separate is fine)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => { console.log('ServiceWorker registered with scope: ', registration.scope); })
                    .catch(error => { console.log('ServiceWorker registration failed: ', error); });
            });
        }
    </script>
</body>
</html>
